import React, { useState } from 'react';
import { Search, Plus, Edit2, Trash2, X, Download, Upload, ChevronDown, ChevronRight, Star, Save, ArrowLeft } from 'lucide-react';

const SettingsPage = () => {
  const [activeTab, setActiveTab] = useState('Call Type');
  const [selectedCallType, setSelectedCallType] = useState(null);
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [editingCallType, setEditingCallType] = useState(null);
  const [selectedDepartment, setSelectedDepartment] = useState('');
  const [searchQuery, setSearchQuery] = useState('');
  const [expandedRows, setExpandedRows] = useState({});

  const callTypes = [
    {
      id: 1,
      callType: 'Aftersales - External Garage Communication',
      direction: 'Both',
      departments: ['Aftersales', 'Aftersales Management'],
      category: 'Aftersales Communication',
      weighting: 5,
      eligibleForConversion: true,
      conversionDefinition: "When a customer's vehicle needs to be scheduled for repair, inspection, or service at either an internal (in-house) or external (partner) garage. The goal is to secure a confirmed booking efficiently, ensuring the customer is informed of the location, date, and time. The agent should match the issue with the appropriate garage, explain what will happen during the visit, and reassure the customer that the matter is being handled promptly.",
      complianceDefinition: "This is an aftersales call initiated by the dealership to an external garage regarding a customer's vehicle repair or service. Evaluate whether the agent communicates accurately and responsibly when discussing the customer's vehicle, work required, costs, and timescales. Check that the agent does not misrepresent customer approval, authorisation, or responsibility for costs, and that any additional work or delays are clearly identified as subject to customer confirmation.",
      whatToListenFor: "This call will be salesperson-initiated, where the agent is reaching out to an external garage or service provider regarding a customer's vehicle repair, maintenance, or service request. The focus is on obtaining status updates, coordinating service timelines, and ensuring smooth communication between all parties. Listen for key details such as the repair progress, estimated completion time, any additional work required, and any costs involved.",
      scoringGuides: [
        {
          id: 1,
          order: 1,
          color: '#2196F3',
          categoryTitle: 'Greeting & Introduction',
          categoryDescription: 'Greeting & Introduction',
          scores: [
            { level: 0, description: 'No greeting or introduction provided.' },
            { level: 1, description: 'Basic greeting but lacks professionalism or clarity.' },
            { level: 2, description: 'Professional greeting with clear identification.' },
            { level: 3, description: 'Excellent greeting, identification, and rapport building.' },
          ],
        },
        {
          id: 2,
          order: 2,
          color: '#9C27B0',
          categoryTitle: 'Information Gathering',
          categoryDescription: 'Information Gathering',
          scores: [
            { level: 0, description: 'Does not gather necessary information.' },
            { level: 1, description: 'Gathers some information but misses key details.' },
            { level: 2, description: 'Gathers most required information effectively.' },
            { level: 3, description: 'Thoroughly gathers all necessary information with follow-up questions.' },
          ],
        },
        {
          id: 3,
          order: 3,
          color: '#FF9800',
          categoryTitle: 'Communication & Clarity',
          categoryDescription: 'Communication & Clarity',
          scores: [
            { level: 0, description: 'Communication is unclear or confusing.' },
            { level: 1, description: 'Communicates basic information but lacks clarity.' },
            { level: 2, description: 'Clear communication with good explanation.' },
            { level: 3, description: 'Exceptional clarity, confirms understanding throughout.' },
          ],
        },
        {
          id: 4,
          order: 4,
          color: '#E91E63',
          categoryTitle: 'Confirming Next Steps & Follow-Up Plan',
          categoryDescription: 'Confirming Next Steps & Follow-Up Plan',
          scores: [
            { level: 0, description: 'Does not confirm next steps at all, leaving uncertainty.' },
            { level: 1, description: 'Mentions next steps but does not confirm or document them.' },
            { level: 2, description: 'Provides clear next steps but does not verify understanding with the garage.' },
            { level: 3, description: 'Ensures the garage fully understands the next steps and confirms the follow-up plan.' },
            { level: 4, description: 'Confirms follow up plan and required timeline.' },
          ],
        },
        {
          id: 5,
          order: 5,
          color: '#4CAF50',
          categoryTitle: 'Professionalism & Collaboration',
          categoryDescription: 'Professionalism & Collaboration',
          scores: [
            { level: 0, description: 'Unprofessional, rude, or uncooperative.' },
            { level: 1, description: 'Polite but lacks collaboration or engagement.' },
            { level: 2, description: 'Professional and cooperative, ensuring smooth communication.' },
            { level: 3, description: 'Highly professional with excellent collaborative approach.' },
          ],
        },
      ],
    },
    {
      id: 2,
      callType: 'Customer Appointment Confirmation',
      direction: 'Outbound',
      departments: ['Sales'],
      category: 'Sales Diary',
      weighting: 5,
      eligibleForConversion: true,
      conversionDefinition: "When a potential customer's appointment is confirmed with all necessary details (time, date, location). The customer agrees to attend and understands what to bring or prepare.",
      complianceDefinition: "Ensure the agent provides accurate information about the appointment, confirms customer understanding, and does not make false promises about vehicle availability or pricing.",
      whatToListenFor: "This call is initiated to confirm a scheduled appointment. Listen for clear communication of appointment details, confirmation from customer, and any questions or concerns addressed professionally.",
      scoringGuides: [
        {
          id: 6,
          order: 1,
          color: '#2196F3',
          categoryTitle: 'Greeting & Intro',
          categoryDescription: 'Greeting & Intro',
          scores: [
            { level: 0, description: 'No greeting provided.' },
            { level: 1, description: 'Basic greeting only.' },
            { level: 2, description: 'Professional greeting with name and purpose.' },
            { level: 3, description: 'Excellent greeting, builds rapport immediately.' },
          ],
        },
        {
          id: 7,
          order: 2,
          color: '#FF5722',
          categoryTitle: 'Appointment Confirmation',
          categoryDescription: 'Appointment Confirmation',
          scores: [
            { level: 0, description: 'Fails to confirm appointment details.' },
            { level: 1, description: 'Confirms some details but misses important information.' },
            { level: 2, description: 'Confirms all key appointment details clearly.' },
            { level: 3, description: 'Thoroughly confirms all details and customer understanding.' },
          ],
        },
      ],
    },
  ];

  const departments = [
    { id: 1, name: 'Aftersales' },
    { id: 2, name: 'Aftersales Management' },
    { id: 3, name: 'Sales' },
    { id: 4, name: 'Buying' },
    { id: 5, name: 'Call Center' },
  ];

  const tabs = [
    'Call Type',
    'Account Settings',
    'Prompt Review',
    'Direct Reports',
    'Call Type Dashboard',
    'Departments',
    'Unlinked External Users',
    'SAR',
  ];

  const toggleRow = (id) => {
    setExpandedRows(prev => ({
      ...prev,
      [id]: !prev[id]
    }));
  };

  const openCallTypeDetail = (callType) => {
    setSelectedCallType(callType);
  };

  const addNewScoringGuide = () => {
    const newGuide = {
      id: Date.now(),
      order: selectedCallType.scoringGuides.length + 1,
      color: '#' + Math.floor(Math.random() * 16777215).toString(16),
      categoryTitle: '',
      categoryDescription: '',
      scores: [
        { level: 0, description: '' },
        { level: 1, description: '' },
        { level: 2, description: '' },
      ],
    };
    // In real app, would update the state properly
  };

  const deleteScoringGuide = (guideId) => {
    // In real app, would remove from state
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white p-6">
      {/* Header */}
      <div className="mb-6">
        <h1 className="text-2xl font-bold mb-4">Settings</h1>

        {/* Tabs */}
        <div className="flex items-center gap-1 border-b border-white/10 overflow-x-auto">
          {tabs.map((tab) => (
            <button
              key={tab}
              onClick={() => setActiveTab(tab)}
              className={`px-4 py-3 text-sm font-medium transition-all whitespace-nowrap ${activeTab === tab
                  ? 'text-orange-400 border-b-2 border-orange-400 bg-white/5'
                  : 'text-gray-400 hover:text-white hover:bg-white/5'
                }`}
            >
              {tab}
            </button>
          ))}
        </div>
      </div>

      {/* Call Type Tab */}
      {activeTab === 'Call Type' && !selectedCallType && (
        <div className="space-y-4">
          {/* Filters & Actions */}
          <div className="flex flex-wrap items-center gap-3 mb-4">
            <div className="relative flex-1 min-w-[250px]">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={18} />
              <input
                type="text"
                placeholder="Search by Call Type"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="w-full pl-10 pr-4 py-2.5 bg-white/5 border border-white/10 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500/50 text-sm"
              />
            </div>

            <select
              value={selectedDepartment}
              onChange={(e) => setSelectedDepartment(e.target.value)}
              className="px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500/50"
            >
              <option value="">Select Department</option>
              {departments.map(dept => (
                <option key={dept.id} value={dept.name}>{dept.name}</option>
              ))}
            </select>

            <button
              onClick={() => setShowCreateModal(true)}
              className="px-4 py-2.5 bg-gradient-to-r from-orange-500 to-pink-500 rounded-lg text-sm hover:shadow-lg hover:shadow-orange-500/30 transition-all font-semibold flex items-center gap-2"
            >
              <Plus size={16} />
              Add New Call Type
            </button>

            <button className="px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-sm hover:bg-white/10 transition-colors flex items-center gap-2">
              <Upload size={16} />
              Import CSV
            </button>

            <button className="p-2.5 bg-white/5 border border-white/10 rounded-lg hover:bg-white/10 transition-colors">
              <Download size={18} className="text-orange-400" />
            </button>
          </div>

          {/* Call Types Table */}
          <div className="bg-white/5 backdrop-blur-sm rounded-xl border border-white/10 overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="bg-gradient-to-r from-slate-800/50 to-slate-900/50 border-b border-white/10">
                  <tr>
                    <th className="text-left py-3 px-4 text-xs font-semibold text-gray-300 w-12"></th>
                    <th className="text-left py-3 px-4 text-xs font-semibold text-gray-300">Call Type</th>
                    <th className="text-left py-3 px-4 text-xs font-semibold text-gray-300">Direction</th>
                    <th className="text-left py-3 px-4 text-xs font-semibold text-gray-300">Departments</th>
                    <th className="text-left py-3 px-4 text-xs font-semibold text-gray-300">Category</th>
                    <th className="text-left py-3 px-4 text-xs font-semibold text-gray-300">Weighting</th>
                    <th className="text-left py-3 px-4 text-xs font-semibold text-gray-300">Conversion</th>
                    <th className="text-left py-3 px-4 text-xs font-semibold text-gray-300">Scoring Guides</th>
                    <th className="text-left py-3 px-4 text-xs font-semibold text-gray-300">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {callTypes.map((callType) => (
                    <React.Fragment key={callType.id}>
                      <tr className="border-b border-white/5 hover:bg-white/10 transition-colors">
                        <td className="py-3 px-4">
                          <button
                            onClick={() => toggleRow(callType.id)}
                            className="p-1 hover:bg-white/10 rounded transition-colors"
                          >
                            {expandedRows[callType.id] ? <ChevronDown size={16} /> : <ChevronRight size={16} />}
                          </button>
                        </td>
                        <td className="py-3 px-4 font-medium">{callType.callType}</td>
                        <td className="py-3 px-4 text-gray-300">{callType.direction}</td>
                        <td className="py-3 px-4">
                          <div className="flex flex-wrap items-center gap-1">
                            {callType.departments.slice(0, 2).map((dept, idx) => (
                              <span key={idx} className="text-xs px-2 py-1 bg-blue-500/20 text-blue-400 rounded">
                                {dept}
                              </span>
                            ))}
                            {callType.departments.length > 2 && (
                              <span className="text-xs text-orange-400">+{callType.departments.length - 2}</span>
                            )}
                          </div>
                        </td>
                        <td className="py-3 px-4 text-gray-300">{callType.category}</td>
                        <td className="py-3 px-4 font-semibold">{callType.weighting}</td>
                        <td className="py-3 px-4">
                          <span className={`px-2 py-1 rounded text-xs font-semibold ${callType.eligibleForConversion ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'
                            }`}>
                            {callType.eligibleForConversion ? 'Yes' : 'No'}
                          </span>
                        </td>
                        <td className="py-3 px-4">
                          <div className="flex items-center gap-2">
                            <span className="text-blue-400 font-semibold">{callType.scoringGuides.length}</span>
                            <span className="text-gray-500 text-xs">criteria</span>
                          </div>
                        </td>
                        <td className="py-3 px-4">
                          <div className="flex items-center gap-2">
                            <button
                              onClick={() => openCallTypeDetail(callType)}
                              className="p-2 hover:bg-blue-500/20 rounded-lg transition-colors"
                              title="View & Edit Details"
                            >
                              <Edit2 size={16} className="text-blue-400" />
                            </button>
                            <button className="p-2 hover:bg-red-500/20 rounded-lg transition-colors">
                              <Trash2 size={16} className="text-red-400" />
                            </button>
                          </div>
                        </td>
                      </tr>

                      {/* Expanded Row - Quick Preview */}
                      {expandedRows[callType.id] && (
                        <tr className="bg-slate-800/30">
                          <td colSpan="9" className="p-4">
                            <div className="grid grid-cols-2 gap-4">
                              <div>
                                <h4 className="text-xs font-semibold text-gray-400 mb-2">What to Listen For</h4>
                                <p className="text-sm text-gray-300 line-clamp-3">{callType.whatToListenFor}</p>
                              </div>
                              <div>
                                <h4 className="text-xs font-semibold text-gray-400 mb-2">Scoring Criteria</h4>
                                <div className="flex flex-wrap gap-2">
                                  {callType.scoringGuides.map((guide) => (
                                    <div
                                      key={guide.id}
                                      className="px-3 py-1.5 rounded-lg text-xs font-medium flex items-center gap-2"
                                      style={{ backgroundColor: guide.color + '20', color: guide.color }}
                                    >
                                      <div className="w-2 h-2 rounded-full" style={{ backgroundColor: guide.color }}></div>
                                      {guide.categoryTitle}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            </div>
                            <button
                              onClick={() => openCallTypeDetail(callType)}
                              className="mt-3 text-sm text-orange-400 hover:text-orange-300 flex items-center gap-1"
                            >
                              View Full Details & Manage Scoring
                              <ChevronRight size={14} />
                            </button>
                          </td>
                        </tr>
                      )}
                    </React.Fragment>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      )}

      {/* Call Type Detail View */}
      {activeTab === 'Call Type' && selectedCallType && (
        <div className="space-y-6">
          {/* Back Button */}
          <button
            onClick={() => setSelectedCallType(null)}
            className="flex items-center gap-2 text-gray-400 hover:text-white transition-colors"
          >
            <ArrowLeft size={18} />
            Back to Call Types
          </button>

          {/* Call Type Header */}
          <div className="bg-gradient-to-r from-orange-500/10 to-pink-500/10 border border-orange-500/20 rounded-xl p-6">
            <div className="flex items-start justify-between mb-4">
              <div>
                <h2 className="text-2xl font-bold mb-2">{selectedCallType.callType}</h2>
                <div className="flex items-center gap-3 text-sm">
                  <span className="px-3 py-1 bg-blue-500/20 text-blue-400 rounded-lg font-medium">
                    {selectedCallType.direction}
                  </span>
                  <span className="text-gray-400">Category: {selectedCallType.category}</span>
                  <span className="text-gray-400">Weighting: <span className="font-bold text-white">{selectedCallType.weighting}</span></span>
                </div>
              </div>
              <button className="p-2 hover:bg-white/10 rounded-lg transition-colors">
                <Edit2 size={18} className="text-orange-400" />
              </button>
            </div>

            <div className="grid grid-cols-3 gap-4">
              <div className="bg-white/5 rounded-lg p-3">
                <div className="text-xs text-gray-400 mb-1">Departments</div>
                <div className="flex flex-wrap gap-1">
                  {selectedCallType.departments.map((dept, idx) => (
                    <span key={idx} className="text-xs px-2 py-1 bg-blue-500/20 text-blue-400 rounded">
                      {dept}
                    </span>
                  ))}
                </div>
              </div>
              <div className="bg-white/5 rounded-lg p-3">
                <div className="text-xs text-gray-400 mb-1">Conversion Eligible</div>
                <span className={`inline-block px-3 py-1 rounded text-sm font-semibold ${selectedCallType.eligibleForConversion ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'
                  }`}>
                  {selectedCallType.eligibleForConversion ? 'Yes' : 'No'}
                </span>
              </div>
              <div className="bg-white/5 rounded-lg p-3">
                <div className="text-xs text-gray-400 mb-1">Scoring Criteria</div>
                <div className="text-2xl font-bold text-blue-400">{selectedCallType.scoringGuides.length}</div>
              </div>
            </div>
          </div>

          {/* Call Type Details */}
          <div className="grid grid-cols-1 gap-4">
            <div className="bg-white/5 backdrop-blur-sm rounded-xl border border-white/10 p-6">
              <h3 className="text-sm font-semibold text-gray-400 mb-3 uppercase tracking-wide">What to Listen For</h3>
              <p className="text-sm text-gray-300 leading-relaxed">{selectedCallType.whatToListenFor}</p>
            </div>

            <div className="bg-white/5 backdrop-blur-sm rounded-xl border border-white/10 p-6">
              <h3 className="text-sm font-semibold text-gray-400 mb-3 uppercase tracking-wide">Conversion Definition</h3>
              <p className="text-sm text-gray-300 leading-relaxed">{selectedCallType.conversionDefinition}</p>
            </div>

            <div className="bg-white/5 backdrop-blur-sm rounded-xl border border-white/10 p-6">
              <h3 className="text-sm font-semibold text-gray-400 mb-3 uppercase tracking-wide">Compliance Definition</h3>
              <p className="text-sm text-gray-300 leading-relaxed">{selectedCallType.complianceDefinition}</p>
            </div>
          </div>

          {/* Scoring Guides Section */}
          <div className="bg-white/5 backdrop-blur-sm rounded-xl border border-white/10 overflow-hidden">
            <div className="p-6 border-b border-white/10 bg-gradient-to-r from-slate-800/30 to-slate-900/30">
              <div className="flex items-center justify-between">
                <div>
                  <h3 className="text-xl font-bold mb-1">Scoring Criteria</h3>
                  <p className="text-sm text-gray-400">Define how this call type will be evaluated</p>
                </div>
                <button
                  onClick={addNewScoringGuide}
                  className="px-4 py-2.5 bg-gradient-to-r from-orange-500 to-pink-500 rounded-lg text-sm hover:shadow-lg hover:shadow-orange-500/30 transition-all font-semibold flex items-center gap-2"
                >
                  <Plus size={16} />
                  Add Scoring Criteria
                </button>
              </div>
            </div>

            <div className="p-6 space-y-4">
              {selectedCallType.scoringGuides.map((guide, index) => (
                <div key={guide.id} className="bg-slate-800/30 rounded-xl border border-white/10 overflow-hidden">
                  {/* Guide Header */}
                  <div className="p-4 border-b border-white/10 flex items-center justify-between" style={{ backgroundColor: guide.color + '10' }}>
                    <div className="flex items-center gap-4">
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-lg flex items-center justify-center text-xl font-bold bg-white/10">
                          {guide.order}
                        </div>
                        <div
                          className="w-6 h-6 rounded-lg cursor-pointer hover:opacity-80 transition-opacity border-2 border-white/20"
                          style={{ backgroundColor: guide.color }}
                          title="Click to change color"
                        ></div>
                      </div>
                      <div>
                        <input
                          type="text"
                          defaultValue={guide.categoryTitle}
                          className="bg-transparent text-lg font-bold outline-none border-b-2 border-transparent hover:border-orange-500/30 focus:border-orange-500 transition-colors px-2"
                          placeholder="Category Title"
                        />
                        <input
                          type="text"
                          defaultValue={guide.categoryDescription}
                          className="block bg-transparent text-sm text-gray-400 outline-none border-b-2 border-transparent hover:border-orange-500/30 focus:border-orange-500 transition-colors px-2 mt-1"
                          placeholder="Category Description"
                        />
                      </div>
                    </div>

                    <div className="flex items-center gap-2">
                      <button className="p-2 hover:bg-red-500/20 rounded-lg transition-colors">
                        <Trash2 size={18} className="text-red-400" />
                      </button>
                    </div>
                  </div>

                  {/* Scoring Levels */}
                  <div className="p-4 space-y-3">
                    {guide.scores.map((score, scoreIdx) => (
                      <div key={scoreIdx} className="flex gap-4 items-start group">
                        <div
                          className="w-12 h-12 rounded-lg flex items-center justify-center text-xl font-bold shrink-0 border-2"
                          style={{
                            backgroundColor: guide.color + '20',
                            borderColor: guide.color + '40',
                            color: guide.color
                          }}
                        >
                          {score.level}
                        </div>
                        <div className="flex-1">
                          <textarea
                            defaultValue={score.description}
                            rows={2}
                            className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-sm resize-none focus:outline-none focus:ring-2 focus:ring-orange-500/50 hover:bg-white/10 transition-colors"
                            placeholder={`Description for level ${score.level}...`}
                          />
                        </div>
                        <button className="p-2 opacity-0 group-hover:opacity-100 hover:bg-red-500/20 rounded-lg transition-all">
                          <Trash2 size={16} className="text-red-400" />
                        </button>
                      </div>
                    ))}

                    <button className="w-full px-4 py-3 bg-white/5 border border-white/10 border-dashed rounded-lg text-sm hover:bg-white/10 transition-colors flex items-center justify-center gap-2 text-gray-400 hover:text-white">
                      <Plus size={16} />
                      Add Score Level
                    </button>
                  </div>
                </div>
              ))}

              {selectedCallType.scoringGuides.length === 0 && (
                <div className="text-center py-12">
                  <Star size={48} className="mx-auto mb-4 text-gray-600" />
                  <h4 className="text-lg font-semibold mb-2">No Scoring Criteria Yet</h4>
                  <p className="text-sm text-gray-400 mb-4">Add scoring criteria to evaluate calls of this type</p>
                  <button
                    onClick={addNewScoringGuide}
                    className="px-6 py-3 bg-gradient-to-r from-orange-500 to-pink-500 rounded-lg text-sm hover:shadow-lg hover:shadow-orange-500/30 transition-all font-semibold inline-flex items-center gap-2"
                  >
                    <Plus size={18} />
                    Add First Scoring Criteria
                  </button>
                </div>
              )}
            </div>

            {/* Save Button */}
            {selectedCallType.scoringGuides.length > 0 && (
              <div className="p-6 border-t border-white/10 bg-slate-900/50 flex items-center justify-end gap-3">
                <button
                  onClick={() => setSelectedCallType(null)}
                  className="px-6 py-2.5 bg-white/5 border border-white/10 rounded-lg text-sm hover:bg-white/10 transition-colors"
                >
                  Cancel
                </button>
                <button className="px-6 py-2.5 bg-gradient-to-r from-orange-500 to-pink-500 rounded-lg text-sm hover:shadow-lg hover:shadow-orange-500/30 transition-all font-semibold flex items-center gap-2">
                  <Save size={16} />
                  Save All Changes
                </button>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Other Tabs */}
      {activeTab !== 'Call Type' && (
        <div className="bg-white/5 backdrop-blur-sm rounded-xl p-12 border border-white/10 text-center">
          <h2 className="text-2xl font-bold mb-2">{activeTab}</h2>
          <p className="text-gray-400">This section is under development</p>
        </div>
      )}
    </div>
  );
};

export default SettingsPage;